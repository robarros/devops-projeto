podTemplate(
    label: 'devops1', 
    cloud: 'minikube',
    containers: [
        containerTemplate(name: 'docker', image: 'docker:dind', args: 'cat', command: '/bin/sh -c', ttyEnabled: true),
        containerTemplate(name: 'bash', image: 'bash', args: 'cat', command: '/bin/sh -c', ttyEnabled: true),
        containerTemplate(name: 'k8s-kubectl', image: 'robarros/k8s-kubectl', args: 'cat', command: '/bin/sh -c', ttyEnabled: true)],
        volumes: [hostPathVolume(mountPath: '/var/run/docker.sock', hostPath: '/var/run/docker.sock')]
)

{
def IMAGE_USER = "robarros/"
def IMAGE_NAME = "app"
def IMAGE_VERSION
def IMAGE_FULL


node('devops1') {

  stage('Checkout') {
    echo 'Checkout do repositorio do GitLab'
    checkout([$class: 'GitSCM', branches: [[name: '*/master']], userRemoteConfigs: [[url: 'https://gitlab.com/robarros/devops-projeto.git']]])
    IMAGE_VERSION = sh returnStdout: true, script: "git describe --tags `git rev-list --tags --max-count=1`"    
    IMAGE_VERSION = IMAGE_VERSION.trim()
    IMAGE_FULL = "${IMAGE_USER}${IMAGE_NAME}:${IMAGE_VERSION}"
    sh "echo ${IMAGE_FULL} > IMAGE_FULL.tag "
    }

  stage('Configs') {
    container('bash') {
      sh returnStdout: true, script: 'sh deploy.sh' 
      sh "ls -lha"
      }}
  
  
  stage('Deploy') {
    container('k8s-kubectl') {
      withKubeConfig(clusterName: 'minikube', contextName: 'minikube', credentialsId: 'minikube', serverUrl: 'https://10.0.0.150:8443') {      
      sh "pwd"
      sh "ls -lha"
      sh 'cat Deployment.yaml'
      }
    }}

 }}